<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>notifIC</title>
    <link rel="stylesheet" href="../css/home.css" />
  </head>

  <body>
    <header>
      <div id="profileButton">
        <img src="https://i.pravatar.cc/40" alt="Perfil" />
      </div>
      <form id="notificacaoForm">
        <input type="text" placeholder="Digite seu número..." />
        <button type="submit">Enviar</button>
      </form>
    </header>

    <section class="banner">
      <img src="../img/banner_ic.png" alt="Banner" />
      <div class="banner-text">
        <h1>./notif<span style="color: deepskyblue">IC</span></h1>
        <p>“Todos os caminhos levam a você.”</p>
        <input type="text" id="searchBar" placeholder="Pesquise no site..." />
      </div>
    </section>

    <aside class="side-menu" id="sideMenu">
      <header>
        <button class="close-btn" onclick="toggleMenu()">←</button>
        <span class="menu-title"
          >./notif<span style="color: deepskyblue">IC</span></span
        >
      </header>

      <nav>
        <a href="#">Início</a>
        <a href="#">Favoritos</a>
        <a href="#">Notificações</a>
        <a href="#">Configurações</a>
        <a href="#">Sair</a>
      </nav>

      <footer>© 2025 ./notifIC</footer>
    </aside>

    <div
      class="side-menu-backdrop"
      id="sideMenuBackdrop"
      onclick="toggleMenu()"
    ></div>

    <div class="tabs">
      <div class="tab" data-tab="pessoal">Pessoal</div>
      <div class="tab active" data-tab="geral">Geral</div>
      <div class="tab" data-tab="vagas">Vagas</div>
    </div>

    <div class="feed-header">
      <h2>Feed</h2>
      <p>Notícias e oportunidades</p>
    </div>

    <section class="feed" id="feed"></section>

    <footer>
      <div>
        <h4>Contato</h4>
        <p>
          Instituto de Computação - UFAL<br />
          (82) 3214-0000<br />
          notific@ic.ufal.br
        </p>
      </div>
      <div>
        <h4>Links Rápidos</h4>
        <p>
          <a href="page_feed.html">Anuncie no site</a><br />
          <a href="#">Contate-nos</a><br />
          <a href="#">Reportar problema</a>
        </p>
      </div>
      <div>
        <h4>./notific</h4>
        <p>
          Plataforma de divulgação de oportunidades e notícias para o Instituto
          de Computação da UFAL.
        </p>
      </div>
    </footer>

    <script>
      const tabs = document.querySelectorAll(".tab");
      const feed = document.getElementById("feed");
      const searchBar = document.getElementById("searchBar");
      const notificacaoForm = document.getElementById("notificacaoForm");
      const profileButton = document.getElementById("profileButton");
      let currentTab = "geral";
      let usuarioLogado = true;

      let data = [];

      async function loadNews() {
        try {
          const res = await fetch("../json/homeNews.json");
          data = await res.json();
          render(currentTab, searchBar.value.toLowerCase());
        } catch (e) {
          feed.innerHTML = "<p>Erro ao carregar notícias.</p>";
        }
      }

      let favoritos = [];

      function atualizarEstadoLogin() {
        if (usuarioLogado) {
          // Não mexe na imagem, apenas garante o menu certo
          document.querySelector("#sideMenu h3").textContent = "Perfil";
        } else {
          document.querySelector("#sideMenu h3").textContent = "Login";
          favoritos = [];
          render(currentTab, searchBar.value.toLowerCase());
        }
      }

      function mostrarModalLogin() {
        const modal = document.createElement("div");
        modal.className = "modal-backdrop";

        modal.innerHTML = `
            <div class="modal-content">
                <h3>Login Necessário</h3>
                <p>Você deve fazer login antes de favoritar conteúdos.</p>
                <button class="modal-button" id="fecharModal">Entendi</button>
            </div>
        `;

        document.body.appendChild(modal);

        modal
          .querySelector("#fecharModal")
          .addEventListener("click", function () {
            document.body.removeChild(modal);
          });
      }

      notificacaoForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const numeroCelular = this.querySelector("input").value;

        if (numeroCelular) {
          alert(
            `Você receberá notificações via Whatsapp no número: ${numeroCelular}`
          );
          this.querySelector("input").value = "";
        }
      });

      profileButton.addEventListener("click", () => {
        sideMenu.classList.add("active");
        sideMenuBackdrop.classList.add("active");
      });

      sideMenuBackdrop.addEventListener("click", () => {
        sideMenu.classList.remove("active");
        sideMenuBackdrop.classList.remove("active");
      });

      function verificarLogin() {
        // Simulação - na implementação real, isso verifica se há um token de sessão
        usuarioLogado = Math.random() > 0.5;
        atualizarEstadoLogin();
      }

      function render(tab, query = "") {
        feed.innerHTML = "";
        let items;

        if (tab === "pessoal") {
          items = [...favoritos];
        } else if (tab === "geral") {
          items = [...data];
        } else if (tab === "vagas") {
          items = data.filter((item) => item.tags.includes("vagas"));
        }

        if (query) {
          items = items.filter(
            (item) =>
              item.title.toLowerCase().includes(query) ||
              item.desc.toLowerCase().includes(query)
          );
        }

        items.forEach((item) => {
          const card = document.createElement("div");
          card.className = "card";

          const isFav = favoritos.some((f) => f.title === item.title);

          let statusHTML = "";
          let timerHTML = "";

          if (item.tags.includes("vagas")) {
            if (item.status === "aberta") {
              statusHTML = `<span class="status aberta">ABERTA</span>`;
              timerHTML = `<div class="timer" data-deadline="${item.deadline}"></div>`;
            } else {
              statusHTML = `<span class="status fechada">FECHADA</span>`;
            }
          }

          card.innerHTML = `
                <span class="favorite ${isFav ? "active" : ""}">★</span>
                <img src="${item.img}" alt="">
                <div>
                  <div class="card-header">
                    <h3>${item.title} ${statusHTML}</h3>
                    ${timerHTML}
                  </div>
                  <p>${item.desc}</p>
                  <a href="${item.link}">Saiba mais...</a>
                </div>
            `;

          card.querySelector(".favorite").addEventListener("click", () => {
            if (!usuarioLogado) {
              mostrarModalLogin();
              return;
            }

            if (isFav) {
              favoritos = favoritos.filter((f) => f.title !== item.title);
            } else {
              favoritos.push(item);
            }
            render(tab, searchBar.value.toLowerCase());
          });

          feed.appendChild(card);
        });

        document.querySelectorAll(".timer").forEach((el) => {
          const deadline = new Date(el.dataset.deadline);
          function updateTimer() {
            const diff = deadline - new Date();
            if (diff <= 0) {
              el.innerHTML = "Expirado";
              return;
            }
            const h = Math.floor(diff / 1000 / 3600);
            const m = Math.floor(((diff / 1000) % 3600) / 60);
            const s = Math.floor((diff / 1000) % 60);
            el.innerHTML = `Encerra em: ${h}h ${m}m ${s}s`;
          }
          updateTimer();
          setInterval(updateTimer, 1000);
        });
      }

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          document.querySelector(".tab.active").classList.remove("active");
          tab.classList.add("active");
          currentTab = tab.dataset.tab;
          render(currentTab, searchBar.value.toLowerCase());
        });
      });

      searchBar.addEventListener("input", () => {
        render(currentTab, searchBar.value.toLowerCase());
      });

      function toggleMenu() {
        sideMenu.classList.toggle("active");
        sideMenuBackdrop.classList.toggle("active");

        // Impede a rolagem do corpo quando o menu está aberto
        document.body.style.overflow = sideMenu.classList.contains("active")
          ? "hidden"
          : "";
      }

      // Inicializar
      loadNews();
      verificarLogin();
    </script>
  </body>
</html>
