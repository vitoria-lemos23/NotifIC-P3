<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfil do Usu√°rio</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/logo-notific.svg') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/perfil.css') }}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>

  <body data-app-user='{{ usuario | default(None) | tojson | safe }}'>
    <script>
      // L√™ o JSON injetado no atributo data-app-user do body
      (function () {
        try {
          const raw = document.body.getAttribute('data-app-user');
          window.APP_USER = raw ? JSON.parse(raw) : null;
        } catch (e) {
          // Em caso de parse inv√°lido, garante que n√£o quebre o JS do cliente
          console.error('Erro ao parsear data-app-user:', e);
          window.APP_USER = null;
        }
      })();
    </script>
    <!-- Header principal (mesma estrutura do home para manter layout) -->
    <header>
      <div class="header-logo">
        <a href="{{ url_for('home_routes.home') }}">
          <img id="logo-img" src="{{ url_for('static', filename='img/notific.svg') }}" alt="√çcone do notifIC" />
        </a>
      </div>

      <!-- Espa√ßo central (busca no home). Mantemos a wrapper vazia para o grid funcionar -->
      <div class="header-search-wrapper"></div>

      <!-- Bot√£o de Notifica√ß√µes (posicionado √† esquerda do perfil) -->
      <div class="header-notifications-wrapper">
        <button id="notificationsButton" class="header-icon-btn" title="Notifica√ß√µes">
          <span class="notifications-icon">üîî</span>
          <span id="notificationBadge" class="notification-badge" style="display:none;">0</span>
        </button>
        <div id="notificationsDropdown" class="notifications-dropdown">
          <div class="notifications-header">
            <h3>Notifica√ß√µes</h3>
            <div class="notification-actions">
              <button id="markAllRead">Marcar como lidas</button>
              <button id="clearAllNotifications">Limpar todas</button>
            </div>
          </div>
          <div id="notificationsList" class="notifications-list">
            <!-- Notifica√ß√µes ser√£o inseridas aqui via JavaScript -->
          </div>
          <div class="notifications-footer">
            <a href="#" class="view-all-link">Ver todas</a>
          </div>
        </div>
      </div>

      <div class="header-user-area">
        <div id="headerUsername" aria-live="polite"></div>
        <div id="profileButton" aria-label="Abrir menu lateral">
          <img src="https://i.pravatar.cc/150" alt="Foto do perfil" />
        </div>
      </div>
    </header>

    <!-- Side menu (same format as home.html) -->
    <aside class="side-menu" id="sideMenu">
      <header>
        <button class="close-btn" onclick="toggleMenu()">‚Üí</button>
        <span class="menu-title">./notif<span style="color: deepskyblue">IC</span></span>
      </header>
      <nav>
        <a href="{{ url_for('home_routes.home') }}">P√°gina Inicial</a>
        <a href="{{ url_for('user_routes.perfil') }}" class="active">Perfil</a>
        <a href="{{ url_for('news_routes.news_page') }}">Cadastrar Not√≠cia</a>
        <a href="#" class="logout-link">Sair</a>
      </nav>
      <footer>¬© 2025 ./notifIC</footer>
    </aside>

    <div class="side-menu-backdrop" id="sideMenuBackdrop" onclick="toggleMenu()"></div>

    <!-- Conte√∫do principal -->
    <main class="profile-container">
      <div class="profile-content">
        <!-- Informa√ß√µes do usu√°rio -->
        <section class="section-container profile-info-section">
          <h2>Informa√ß√µes</h2>
          <div class="profile-details">
            <div class="profile-avatar">
              <img
                id="profile-picture"
                src="https://i.pravatar.cc/150"
                alt="Foto de Perfil"
              />
              <div class="avatar-actions">
                <button id="change-photo-btn" type="button">
                  <i class="fas fa-camera"></i> Mudar foto de perfil
                </button>
                <input
                  type="file"
                  id="photo-upload"
                  accept="image/*"
                  style="display: none"
                />
                <button id="choose-photo-btn" type="button">
                  <i class="fas fa-upload"></i> Escolher foto
                </button>
              </div>
            </div>

            <form class="user-info-fields">
              <div class="info-group">
                <label for="username">Nome de usu√°rio</label>
                <input
                  type="text"
                  id="username"
                  name="username"
                  placeholder="Nome"
                  disabled
                />
              </div>
              <div class="info-group">
                <label for="email">Email cadastrado</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  placeholder="Email"
                  disabled
                />
              </div>
              <div class="info-group">
                <label for="role">Cargo</label>
                <input type="text" id="role" name="role" disabled />
              </div>
            </form>
          </div>
        </section>

        <!-- Prefer√™ncias de notifica√ß√µes -->
        <section class="section-container notification-section">
          <h2>Prefer√™ncias de Notifica√ß√µes</h2>
          <div class="preferences-list">
            <div class="preference-item">
              <span>EVENTO</span>
              <label class="switch">
                <input type="checkbox" checked />
                <span class="slider round"></span>
              </label>
            </div>
            <div class="preference-item">
              <span>PROJETO</span>
              <label class="switch">
                <input type="checkbox" checked />
                <span class="slider round"></span>
              </label>
            </div>
            <div class="preference-item">
              <span>VAGA</span>
              <label class="switch">
                <input type="checkbox" checked />
                <span class="slider round"></span>
              </label>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script src="{{ url_for('static', filename='javascript/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='javascript/perfil.js') }}"></script>
    <script src="{{ url_for('static', filename='javascript/perfil_page.js') }}"></script>
    <script>
      // Fun√ß√£o para inicializar handlers e sistema de notifica√ß√µes
      function initProfilePage() {
        console.log('[profile] initProfilePage()');

        // Inicializa o sistema de notifica√ß√µes
        if (typeof initNotificationSystem === 'function') {
          initNotificationSystem();
        }

        // Bind handlers para logout e notifica√ß√µes
        bindHandlers();
      }

      function bindHandlers() {
        console.log('[profile] bindHandlers()');

        // Logout links
        const logoutEls = document.querySelectorAll('.logout-link');
        logoutEls.forEach(function (el) {
          el.removeEventListener('click', logoutHandler);
          el.addEventListener('click', logoutHandler);
        });

        // Notification button handler (usa o sistema modularizado)
        const nb = document.getElementById('notificationsButton');
        if (nb) {
          nb.addEventListener('click', function (e) {
            console.log('[profile] notificationsButton clicked');
            e.stopPropagation();
            if (typeof notificationSystem !== 'undefined' && notificationSystem && typeof notificationSystem.toggleDropdown === 'function') {
              try {
                notificationSystem.toggleDropdown();
              } catch (err) {
                console.error('notificationSystem error:', err);
              }
            } else {
              // Fallback: toggle class no dropdown
              const dd = document.getElementById('notificationsDropdown');
              if (dd) dd.classList.toggle('active');
            }
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (ev) {
          const dropdown = document.getElementById('notificationsDropdown');
          if (dropdown && dropdown.classList.contains('active')) {
            if (ev.target.closest && (ev.target.closest('#notificationsDropdown') || ev.target.closest('#notificationsButton'))) return;
            dropdown.classList.remove('active');
          }
        });
      }

      function logoutHandler(e) {
        e.preventDefault();
        (async function() {
          try {
            await fetch("{{ url_for('auth_routes.logout') }}", {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type': 'application/json' },
            });
          } catch (err) {
            // ignore network errors
          }
          window.location = "{{ url_for('home_routes.home') }}";
        })();
      }

      // Inicializa quando o DOM estiver pronto
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initProfilePage);
      } else {
        initProfilePage();
      }
    </script>
  </body>
</html>